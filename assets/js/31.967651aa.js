(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{440:function(e,t,r){"use strict";r.r(t);var a=r(2),n=Object(a.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h2",{attrs:{id:"一、基础信息"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一、基础信息"}},[e._v("#")]),e._v(" 一、基础信息")]),e._v(" "),t("p",[e._v("项目中有一个生成合同的操作，也就是生成 PDF 文件。")]),e._v(" "),t("p",[e._v("设想是另起一个 Node 服务，该服务连接数据库查询所需数据，再生成对应的 PDF 文件。")]),e._v(" "),t("p",[e._v("Node 服务用到的框架是 "),t("a",{attrs:{href:"https://adonisjs.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("AdonisJS"),t("OutboundLink")],1),e._v("（一个服务端渲染的 MVC 框架）。\n"),t("br"),e._v("\n之前有参与过 Java 项目开发，对后端开发有一定了解的话比较容易上手。\n"),t("br"),e._v("\nAdonisJS 有一整套完整的解决方案，复杂度不高的项目非常合适，开箱即用。")]),e._v(" "),t("p",[e._v("然后经由 "),t("a",{attrs:{href:"https://github.com/puppeteer/puppeteer",target:"_blank",rel:"noopener noreferrer"}},[e._v("Puppeteer"),t("OutboundLink")],1),e._v("生成 PDF 操作。\n"),t("br"),e._v("\nPuppeteer 是一个 Node.js 库，它提供了一个高级 API 来控制 DevTools 协议上的 Chrome/Chromium。")]),e._v(" "),t("h2",{attrs:{id:"实现细节"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实现细节"}},[e._v("#")]),e._v(" 实现细节")]),e._v(" "),t("ul",[t("li",[e._v("Node 服务中增加接口 "),t("code",[e._v("/transformPDF")]),e._v("，由第三方调用，生成 PDF 文件上传 CDN\n"),t("ul",[t("li",[e._v("第三方调用 -> 携带参数 pwd 鉴权 -> Node 访问合同模板 URL -> 判断页面加载完成 -> 生成 PDF -> 上传 PDF 到 CDN -> 返回 CND 的 URL\n"),t("br")])])]),e._v(" "),t("li",[e._v("编写一个 HTML 合同模板\n"),t("ul",[t("li",[e._v("页面发起请求 -> 转发参数 pwd 用于鉴权 -> 获得结果 -> 渲染页面\n"),t("br")])])]),e._v(" "),t("li",[e._v("Node 服务中增加接口 "),t("code",[e._v("/getDetail")]),e._v(" ，响应结果用于展示合同模板内容\n"),t("ul",[t("li",[e._v("页面发起请求 -> 鉴权 pwd 字段 -> 返回结果")])])])]),e._v(" "),t("h3",{attrs:{id:"示意流程图"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#示意流程图"}},[e._v("#")]),e._v(" 示意流程图")]),e._v(" "),t("img",{attrs:{src:e.$withBase("/assets/images/230820_1.png"),alt:"示意流程图"}}),e._v(" "),t("h2",{attrs:{id:"遇到的问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#遇到的问题"}},[e._v("#")]),e._v(" 遇到的问题")]),e._v(" "),t("p",[e._v("1、服务器的浏览器只有字母、数字等字体包，没有中文汉字字体包。导致导出的 PDF 是乱码，安装渲染字体即可解决。")]),e._v(" "),t("img",{attrs:{src:e.$withBase("/assets/images/230820_2.png"),alt:"PDF乱码"}}),e._v(" "),t("p",[e._v("2、在判断数据加载完成（接口异步）和页面渲染数据完成时的时机选择。（在什么节点数据和渲染都成功了）")]),e._v(" "),t("ul",[t("li",[e._v("方案一：某个接口有响应结果，即为生成 PDF 时机（可能出现该接口成功了，别的接口还没有）")]),e._v(" "),t("li",[e._v("方案二：联合多个接口响应结果，为生成 PDF 时机（经常超时，不知为何）")]),e._v(" "),t("li",[e._v("方案三：固定延迟 N 秒 + 获取到 HTML 某个节点元素的内容。（采用的方案）")])]),e._v(" "),t("p",[e._v("3、太久没有写后端导致写 SQL 的不利索，和对 AdonisJS 的 API 运用不熟练。")]),e._v(" "),t("h2",{attrs:{id:"优化方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#优化方案"}},[e._v("#")]),e._v(" 优化方案")]),e._v(" "),t("p",[e._v("1、生成一个 PDF 大约要 4~6s，调用方现用的是同步等待方式，用户体验不是很好。")]),e._v(" "),t("p",[e._v("2、把多个接口数据合并成一个接口，能解决方案一、方案二的问题。预计可减少 2~3s。")]),e._v(" "),t("p",[e._v("3、失败后重试自旋机制。")]),e._v(" "),t("h2",{attrs:{id:"参见"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参见"}},[e._v("#")]),e._v(" 参见")]),e._v(" "),t("p",[t("RouterLink",{attrs:{to:"/views/react/230730.html"}},[e._v("HTML 打印中 PT 单位的应用与实践")])],1),e._v(" "),t("p",[t("a",{attrs:{href:"https://adonisjs.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("AdonisJS"),t("OutboundLink")],1)]),e._v(" "),t("p",[t("a",{attrs:{href:"https://github.com/puppeteer/puppeteer",target:"_blank",rel:"noopener noreferrer"}},[e._v("Puppeteer"),t("OutboundLink")],1)]),e._v(" "),t("p",[t("a",{attrs:{href:"https://github.com/puppeteer/examples/blob/master/element-to-pdf.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("element-to-pdf"),t("OutboundLink")],1)]),e._v(" "),t("p",[t("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/76237595",target:"_blank",rel:"noopener noreferrer"}},[e._v("结合项目来谈谈 Puppeteer"),t("OutboundLink")],1)]),e._v(" "),t("p",[t("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/524254998",target:"_blank",rel:"noopener noreferrer"}},[e._v("玩转 Puppeteer"),t("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=n.exports}}]);